// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider  = "postgresql"
}

model Employee {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  ippisNumber String @unique
  firstName String
  lastName  String
  email     String  @unique
  department String?
  createdAt DateTime @default(now())
  createdBy Int?
  updatedAt DateTime @updatedAt
  updatedBy Int?
  deletedAt DateTime?

  payslips Payslip[]

  @@index([uuid])
  @@map("employees")
}

model Payslip {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  ippisNumber String
  fileName  String
  filePath  String
  pdfContent Bytes
  employeeId Int
  employee  Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  uploadId  Int
  upload    PayslipUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  payMonth  String  // Format: YYYY-MM (e.g., "2025-12" for December 2025)
  emailSent Boolean @default(false)
  emailSentAt DateTime?
  emailError String? // Store error message if email fails
  createdAt DateTime @default(now())
  createdBy Int?
  updatedAt DateTime @updatedAt
  updatedBy Int?
  deletedAt DateTime?

  @@index([ippisNumber])
  @@index([employeeId])
  @@index([uploadId])
  @@index([payMonth])
  @@index([uuid])
  @@map("payslips")
}

model PayslipUpload {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  fileName  String
  filePath  String
  payMonth  String  // Format: YYYY-MM (e.g., "2025-12" for December 2025)
  totalFiles Int
  processedFiles Int @default(0) // Files successfully processed and saved
  successCount Int @default(0) // Emails successfully sent
  failureCount Int @default(0) // Emails failed to send
  status    String @default("pending") // pending, processing, processed, sending, completed, failed
  emailStatus String @default("pending") // pending, sending, completed, partial, failed
  sentAt    DateTime? // When batch email sending was initiated
  completedAt DateTime? // When batch email sending completed
  createdAt DateTime @default(now())
  createdBy Int?
  updatedAt DateTime @updatedAt
  updatedBy Int?
  deletedAt DateTime?

  payslips  Payslip[]

  @@index([uuid])
  @@index([payMonth])
  @@index([status])
  @@index([emailStatus])
  @@map("payslip_uploads")
}

model User {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  email     String  @unique
  password  String
  firstName String?
  lastName  String?
  role      String  @default("user") // user, admin, payroll_manager
  permissions String[] @default([]) // comma-separated: payslips:read, payslips:write, employees:read, employees:write, etc.
  isActive  Boolean @default(true)
  isLocked  Boolean @default(false) // locked after 5 failed login attempts
  failedLoginAttempts Int @default(0) // tracks consecutive failed attempts
  lastLoginAt DateTime? // tracks last successful login
  emailVerified Boolean @default(false) // email verification status
  emailVerifiedAt DateTime? // when email was verified
  twoFactorEnabled Boolean @default(false) // 2FA toggle
  createdAt DateTime @default(now())
  createdBy Int?
  updatedAt DateTime @updatedAt
  updatedBy Int?
  deletedAt DateTime?

  passwordResets PasswordReset[] @relation("passwordResets")
  auditLogs AuditLog[] @relation("auditLogs")
  verificationTokens VerificationToken[] @relation("verificationTokens")
  twoFactorTokens TwoFactorToken[] @relation("twoFactorTokens")

  @@index([uuid])
  @@index([email])
  @@map("users")
}

model PasswordReset {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  userId    Int
  user      User    @relation("passwordResets", fields: [userId], references: [id], onDelete: Cascade)
  token     String  @unique // 6-digit numeric token
  expiresAt DateTime // token expiration time
  usedAt    DateTime? // when token was used to reset password
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("password_resets")
}

model VerificationToken {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  userId    Int
  user      User    @relation("verificationTokens", fields: [userId], references: [id], onDelete: Cascade)
  token     String  @unique // unique verification token
  type      String  // "email_verification" or "email_change"
  expiresAt DateTime // token expiration time
  usedAt    DateTime? // when token was used
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("verification_tokens")
}

model TwoFactorToken {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  userId    Int
  user      User    @relation("twoFactorTokens", fields: [userId], references: [id], onDelete: Cascade)
  token     String  @unique // 6-digit numeric token
  expiresAt DateTime // token expiration time (10 minutes)
  usedAt    DateTime? // when token was used
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("two_factor_tokens")
}

model AuditLog {
  id        Int     @id @default(autoincrement())
  uuid      String  @unique @default(uuid())
  userId    Int? // user who performed the action (nullable for system actions)
  user      User?   @relation("auditLogs", fields: [userId], references: [id], onDelete: SetNull)
  action    String // e.g., "LOGIN", "UPDATE_EMPLOYEE", "DELETE_USER", "UPLOAD_PAYSLIP"
  resource  String? // e.g., "employee", "payslip", "user" (what was affected)
  resourceId Int? // ID of the affected resource
  details   Json? // additional context as JSON
  ipAddress String? // IP address of the requester
  userAgent String? // browser/client info
  status    String @default("success") // success, failure
  errorMessage String? // error details if status is failure
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

model Role {
  id          Int      @id @default(autoincrement())
  uuid        String   @unique @default(uuid())
  name        String   @unique
  description String?
  permissions String[] @default([])
  isSystem    Boolean  @default(false) // true for admin, payroll_manager, user
  createdAt   DateTime @default(now())
  createdBy   Int?
  updatedAt   DateTime @updatedAt
  updatedBy   Int?
  deletedAt   DateTime?

  @@index([uuid])
  @@index([name])
  @@map("roles")
}
